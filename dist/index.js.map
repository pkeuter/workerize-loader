{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import path from 'path';\nimport loaderUtils from 'loader-utils';\n\nimport NodeTargetPlugin from 'webpack/lib/node/NodeTargetPlugin';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\n\nexport default function loader() {}\n\nconst CACHE = {};\nconst tapName = 'workerize-loader';\n\nfunction compilationHook(compiler, handler) {\n\tif (compiler.hooks) {\n\t\treturn compiler.hooks.compilation.tap(tapName, handler);\n\t}\n\treturn compiler.plugin('compilation', handler);\n}\n\nfunction parseHook(data, handler) {\n\tif (data.normalModuleFactory.hooks) {\n\t\treturn data.normalModuleFactory.hooks.parser.for('javascript/auto').tap(tapName, handler);\n\t}\n\treturn data.normalModuleFactory.plugin('parser', handler);\n}\n\nfunction exportDeclarationHook(parser, handler) {\n\tif (parser.hooks) {\n\t\treturn parser.hooks.exportDeclaration.tap(tapName, handler);\n\t}\n\treturn parser.plugin('export declaration', handler);\n}\n\nloader.pitch = function(request) {\n\tthis.cacheable(false);\n\n\tconst options = loaderUtils.getOptions(this) || {};\n\n\tconst cb = this.async();\n\n\tconst filename = loaderUtils.interpolateName(this, `${options.name || '[fullhash]'}.worker.js`, {\n\t\tcontext: options.context || this.rootContext || this.options.context,\n\t\tregExp: options.regExp\n\t});\n\n\tconst worker = {};\n\n\tworker.options = {\n\t\tfilename,\n\t\tchunkFilename: `[id].${filename}`,\n\t\tnamedChunkFilename: null\n\t};\n\n\tconst compilerOptions = this._compiler.options || {};\n\tif (compilerOptions.output && compilerOptions.output.globalObject==='window') {\n\t\tconsole.warn('Warning (workerize-loader): output.globalObject is set to \"window\". It should be set to \"self\" or \"this\" to support HMR in Workers.');\n\t}\n\n\tworker.compiler = this._compilation.createChildCompiler('worker', worker.options);\n\n\t(new WebWorkerTemplatePlugin(worker.options)).apply(worker.compiler);\n\n\tif (this.target!=='webworker' && this.target!=='web') {\n\t\t(new NodeTargetPlugin()).apply(worker.compiler);\n\t}\n\n\t// webpack >= v4 supports webassembly\n\tlet wasmPluginPath = null;\n\ttry {\n\t\twasmPluginPath = require.resolve(\n\t\t\t'webpack/lib/web/FetchCompileWasmTemplatePlugin'\n\t\t);\n\t}\n\tcatch (_err) {\n\t\t// webpack <= v3, skipping\n\t}\n\n\tif (wasmPluginPath) {\n\t\t// eslint-disable-next-line global-require\n\t\tconst FetchCompileWasmTemplatePlugin = require(wasmPluginPath);\n\t\tnew FetchCompileWasmTemplatePlugin({\n\t\t\tmangleImports: this._compiler.options.optimization.mangleWasmImports\n\t\t}).apply(worker.compiler);\n\t}\n\n\t(new SingleEntryPlugin(this.context, `!!${path.resolve(__dirname, 'rpc-worker-loader.js')}!${request}`, 'main')).apply(worker.compiler);\n\n\tconst subCache = `subcache ${__dirname} ${request}`;\n\n\tcompilationHook(worker.compiler, (compilation, data) => {\n\t\tif (compilation.cache) {\n\t\t\tlet cache;\n\t\t\tif (compilation.cache instanceof Map) {\n\t\t\t\tcache = compilation.cache.get(subCache);\n\t\t\t\tif (!cache) {\n\t\t\t\t\tcache = new Map();\n\t\t\t\t\tcompilation.cache.set(subCache, cache);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (!compilation.cache[subCache]) {\n\t\t\t\tcache = compilation.cache[subCache] = {};\n\t\t\t}\n\t\t\t\n\t\t\tcompilation.cache = cache;\n\t\t}\n\t\tparseHook(data, (parser, options) => {\n\t\t\texportDeclarationHook(parser, expr => {\n\t\t\t\tlet decl = expr.declaration || expr;\n\t\t\t\tlet\t{ compilation, current } = parser.state;\n\n\t\t\t\tlet entryModule =\n\t\t\t\t\tcompilation.entries instanceof Map\n\t\t\t\t\t\t? compilation.moduleGraph.getModule(\n\t\t\t\t\t\t\tcompilation.entries.get('main').dependencies[0]\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: compilation.entries[0];\n\n\t\t\t\t// only process entry exports\n\t\t\t\tif (current.resource!==entryModule.resource) return;\n\n\t\t\t\tlet key = current.nameForCondition();\n\t\t\t\tlet exports = CACHE[key] || (CACHE[key] = {});\n\t\t\t\tif (decl.id) {\n\t\t\t\t\texports[decl.id.name] = true;\n\t\t\t\t}\n\t\t\t\telse if (decl.declarations) {\n\t\t\t\t\tfor (let i=0; i<decl.declarations.length; i++) {\n\t\t\t\t\t\texports[decl.declarations[i].id.name] = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tconsole.warn('[workerize] unknown export declaration: ', expr);\n\t\t\t\t}\n\n\t\t\t\t// This is for Webpack 5: mark the exports as used so it does not get tree-shaken away on production build\n\t\t\t\tif (compilation.moduleGraph) {\n\t\t\t\t\tconst { getEntryRuntime } = require('webpack/lib/util/runtime');\n\t\t\t\t\tconst { UsageState } = require('webpack');\n\t\t\t\t\tconst runtime = getEntryRuntime(compilation, 'main');\n\t\t\t\t\tfor (const exportName of Object.keys(exports)) {\n\t\t\t\t\t\tconst exportInfo = compilation.moduleGraph.getExportInfo(entryModule, exportName);\n\t\t\t\t\t\texportInfo.setUsed(UsageState.Used, runtime);\n\t\t\t\t\t\texportInfo.canMangleUse = false;\n\t\t\t\t\t\texportInfo.canMangleProvide = false;\n\t\t\t\t\t}\n\t\t\t\t\tcompilation.moduleGraph.addExtraReason(entryModule, 'used by workerize-loader');\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t});\n\n\tworker.compiler.runAsChild((err, entries, compilation) => {\n\t\tif (err) return cb(err);\n\n\t\tif (entries[0]) {\n\t\t\tworker.file = Array.from(entries[0].files)[0];\n\t\t\tconst entryModules =\n\t\t\t\tcompilation.chunkGraph &&\n\t\t\t\tcompilation.chunkGraph.getChunkEntryModulesIterable\n\t\t\t\t\t? Array.from(\n\t\t\t\t\t\tcompilation.chunkGraph.getChunkEntryModulesIterable(entries[0])\n\t\t\t\t\t  )\n\t\t\t\t\t: null;\n\t\t\tconst entryModule =\n\t\t\t\tentryModules && entryModules.length > 0\n\t\t\t\t\t? entryModules[0]\n\t\t\t\t\t: entries[0].entryModule;\n\n\t\t\tlet key = entryModule.nameForCondition();\n\t\t\tlet contents = compilation.assets[worker.file].source();\n\t\t\tlet exports = Object.keys(CACHE[key] || {});\n\n\t\t\t// console.log('Workerized exports: ', exports.join(', '));\n\n\t\t\tif (options.inline) {\n\t\t\t\tworker.url = `URL.createObjectURL(new Blob([${JSON.stringify(contents)}]))`;\n\t\t\t}\n\t\t\telse if (options.publicPath) {\n\t\t\t\tworker.url = `${JSON.stringify(options.publicPath + worker.file)}`;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tworker.url = `__webpack_public_path__ + ${JSON.stringify(worker.file)}`;\n\t\t\t}\n\n\t\t\tif (options.fallback === false) {\n\t\t\t\tdelete this._compilation.assets[worker.file];\n\t\t\t}\n\n\t\t\tlet workerUrl = worker.url;\n\t\t\tif (options.import) {\n\t\t\t\tworkerUrl = `\"data:,importScripts('\"+location.origin+${workerUrl}+\"')\"`;\n\t\t\t}\n\n\t\t\treturn cb(null, `\n\t\t\t\tvar addMethods = require(${loaderUtils.stringifyRequest(this, path.resolve(__dirname, 'rpc-wrapper.js'))})\n\t\t\t\tvar methods = ${JSON.stringify(exports)}\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(${workerUrl}, { name: ${JSON.stringify(filename)} })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t${ options.ready ? 'w.ready = new Promise(function(r) { w.addEventListener(\"ready\", function(){ r(w) }) })' : '' }\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t`);\n\t\t}\n\n\t\treturn cb(null, null);\n\t});\n};\n"],"names":["const","let","this"],"mappings":"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"}